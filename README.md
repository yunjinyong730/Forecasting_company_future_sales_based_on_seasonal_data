# 💸계절성 있는 시계열 데이터 기반 기업 미래 매출 예측하기

## 프로젝트 개요

이 노트북은 **Kaggle “Predict Future Sales”** 데이터의 `sales` 테이블을 사용하여 매달 매출(`revenue = item_cnt_day × item_price`)을 집계하고, 다양한 시계열/딥러닝 모델을 이용해 향후 **5개월간 매출을 예측**하는 전 과정을 한 번에 구현한 것이다. 데이터는 2013-01부터 2015-10까지 총 **34개월**만 존재하여 계절성 모델과 딥러닝 모델의 학습에 제약이 있었으며, 외부 변수는 평균 가격(`avg_price`), 활동 상점 수(`active_shops`), 활동 아이템 수(`active_items`)까지 4개만 사용하였다.

### 데이터 전처리

1. **데이터 정리** – `item_price ≤ 0`인 행은 삭제하고 반품(음수 판매량)은 `0`으로 클리핑하였다. 이후 `revenue = item_cnt_day × item_price`를 계산하고 `date_block_num` 단위(월 단위)로 집계하였다.
2. **월별 지표 생성** – 매월 매출(`y_rev`)뿐만 아니라 판매수량(`y_cnt`), 평균 가격(`avg_price`), 활성 상점 수(`active_shops`), 활성 아이템 수(`active_items`) 등을 계산하였다. 이러한 변수들은 딥러닝 모델의 **입력 특징**으로 쓰였다.
3. **시간 범위** – 월 시작일을 `ds` 컬럼으로 생성하여 2013-01-01부터 2015-10-01까지 34개월의 시계열을 얻었다.

EDA 결과 월별 매출은 아래 그림처럼 **크게 세 번의 스파이크**(2013-10, 2014-01, 2014-12/2015-01)와 장기적 하락 추세를 보였다. 12개월 이동 평균/표준편차도 감소하는 경향이 있어 **최근 매출이 낮아지는 환경**임을 의미한다.

<img width="1160" height="463" alt="image" src="https://github.com/user-attachments/assets/8f2dd9e4-1963-4d9b-a567-d3f5c32e0b37" />


## 모델링 접근

모델 비교는 단순 베이스라인부터 계절 ARIMA, Holt-Winters, 그리고 딥러닝 모델까지 **6개 모델**을 학습하였다. 평가 지표는 **RMSE**와 **SMAPE**(Symmetric Mean Absolute Percentage Error)를 사용한다. 검증은 크게 두 가지로 진행하였다:

1. **Holdout Backtest** – 마지막 5개월(2015-06 ~ 2015-10)을 떼어내어 과거 29개월로 학습하고, 미래 5개월의 매출을 예측하여 성능을 비교하였다.
2. **TimeSeries Cross-Validation(Expanding Window)** – 초기 24개월을 학습한 뒤 horizon=5개월 예측을 반복하는 **6개의 폴드**를 구성하여 각 모델의 평균 성능을 평가하였다. 딥러닝 모델은 계산량 문제로 **최근 5개 폴드만** 학습했다.

각 모델의 핵심을 간단히 요약하면 다음과 같다.

| 모델 | 설명 | 특징 |
| --- | --- | --- |
| **Baseline LastMonth** | 마지막 학습월의 매출을 그대로 앞으로 5개월에 반복 | 간단하지만 추세가 완만할 때 강력한 기준점 |
| **Baseline MA12** | 최근 12개월 평균 매출을 5개월 내내 예측 | 추세 변동을 완전히 무시하여 비교 지점으로 사용 |
| **SARIMAX** | 간단한 ARIMA 후보(\(p,d,q\) = \{(1,1,1),(2,1,1),(1,1,2)\})와 계절(12개월) 후보를 조합 후 AIC가 가장 낮은 모델 선택 | 계절성 모형이나 데이터 길이가 짧아 과적합 위험이 큼 |
| **ETS (Holt-Winters)** | Trend/seasonal 구성(additive/multiplicative/없음)을 탐색하여 AIC 또는 SSE가 최소인 설정을 선택 | 잔차 표준편차와 \(\sqrt{h}\)를 이용해 간단한 예측구간을 근사 |
| **iTransformer-like** | 최근 연구인 *iTransformer*에서 영감을 받아 **변수 토큰**을 만든 후 Transformer encoder로 변수간 상관을 학습하여 5개월의 분위수(0.05/0.5/0.95) 예측 | 입력길이 12, 토큰 수 4, d_model=64; 큐앙타일 손실 사용 |
| **TimesNet** | FFT를 통해 주기 후보를 찾고 각 주기로 2D로 재구성해 Inception-style Conv2D로 패턴을 추출하는 모델 | top-k=3개의 주기를 사용해 여러 주기 패턴을 가중합 |


## Holdout Backtest 결과 (2015-06 ~ 2015-10 예측)

표 1은 마지막 5개월을 예측한 후의 **RMSE와 SMAPE** 성능을 요약한 것이다(수치는 원 단위이며 작은 값이 좋다). **SARIMAX는 예측이 비정상적으로 커져** RMSE \(>10^9\)이고 SMAPE 163%로 매우 나쁜 성능을 보여 표에 포함하지 않았다.

| 모델 | RMSE | SMAPE |
| --- | ---:| ---:|
| **Baseline LastMonth** | 20 729 310 | 22.9 % |
| **iTransformer_DL** | 23 403 950 | **22.7 %** |
| **ETS** | 23 238 080 | 26.6 % |
| **TimesNet_DL** | 30 052 130 | 32.4 % |
| **Baseline MA12** | 40 525 620 | 42.8 % |

**해석**

- Baseline LastMonth가 가장 낮은 RMSE를 기록했고 SMAPE는 22.9 %로 딥러닝 모델과 비슷했다. 이는 매출이 최근 낮은 수준에 머물러 있어 **마지막 값 반복**이 꽤 정확한 예측이었음을 뜻한다.
- **iTransformer_DL**의 중앙값 예측은 가장 낮은 SMAPE(22.7 %)를 달성했지만 RMSE는 베이스라인보다 약간 높았다. 딥러닝 모델이 일부 패턴을 포착했지만 데이터가 짧아 불안정한 면이 있다.
- **ETS**는 SARIMAX보다 훨씬 안정적인 예측을 제공하며 RMSE/SMAPE가 베이스라인에 근접한다.
- **TimesNet_DL**은 학습 데이터가 적어 주기 추정이 어려워서 비교적 부진하였다.

아래 그림은 holdout 구간에서 실제 매출과 각 모델 예측을 비교한 것이다. SARIMAX 예측이 5 억 ~ 10 억 단위로 치솟으며 신뢰할 수 없음을 확인할 수 있다.

<img width="1150" height="540" alt="image" src="https://github.com/user-attachments/assets/72ba8ede-db21-4cb4-8c33-b1b8770f0552" />



## TimeSeries Cross-Validation 결과

Expanding window CV(6개 폴드)에서 각 모델의 평균 RMSE/SMAPE를 계산하였다. CV는 시계열 데이터에 더 공정한 평가를 제공하며 **모델 선택**에 사용되었다.

| 모델 | RMSE | SMAPE |
| --- | ---:| ---:|
| **iTransformer_DL** | **19 442 930** | **20.1 %** |
| **ETS** | 19 994 170 | 20.4 % |
| **Baseline LastMonth** | 42 139 660 | 33.6 % |
| **Baseline MA12** | 35 163 110 | 35.9 % |
| **TimesNet_DL** | 42 748 160 | 36.9 % |

**해석**

- iTransformer_DL가 가장 낮은 RMSE와 SMAPE를 기록하여 **CV 기준 베스트 모델**로 선정되었다. 상대적으로 ETS도 비슷한 성능을 보여 작은 데이터셋에서 통계적 방법이 여전히 강력함을 시사한다.
- 베이스라인들과 TimesNet은 CV에서도 높은 오차를 보여 모델링 개선이 필요함을 보여준다.


## 최종 모델 재학습 및 향후 5개월 예측

CV에서 선택된 **iTransformer_DL** 모델을 전체 34개월 데이터로 재학습한 뒤 향후 5개월(2015-11 ~ 2016-03)을 예측하였다. 딥러닝 모델은 0.05/0.5/0.95 분위수를 동시에 예측하므로 **예측 구간**을 산출할 수 있다. 예측값은 이후 기준선(최근 12개월 평균 매출=101.9 M)과 비교해 리스크를 분류하였다. 표 2는 그 결과를 요약한다.

| 월 | 예측 중앙값 | 95 % 구간 (하단 – 상단) | 리스크 분류 |
|---|---:|---:|---|
| **2015-11** | 144.8 M | 131.1 M – 163.3 M | **Low downside risk + Upside potential** |
| **2015-12** | 180.5 M | 108.7 M – 227.5 M | **Low downside risk + Upside potential** |
| **2016-01** | 152.2 M | 107.0 M – 175.4 M | **Low downside risk + Upside potential** |
| **2016-02** | 96.2 M | 97.1 M – 139.3 M | **Medium downside risk + Upside potential** |
| **2016-03** | 91.8 M | 83.4 M – 148.1 M | **High downside risk + Upside potential** |

예측값과 과거 실적을 함께 표시한 그래프는 다음과 같다. 경고선은 최근 12개월 평균 매출이다.

<img width="1161" height="537" alt="image" src="https://github.com/user-attachments/assets/790c3b91-2d3c-44a0-a720-4a4596cb23ce" />


**해석**

- **2015-11~12**: 모델은 작년 겨울 시즌의 큰 스파이크를 반영해 매출이 1.5~1.8억 원대로 급증할 것으로 예측했다. 하방 위험이 낮고 상방 잠재력이 있어 긍정적인 전망으로 해석된다.
- **2016-01**: 평균 1.5억 원으로 예상되며 하위 구간이 기준선보다 높아 **low risk**이다.
- **2016-02**: 평균 9.6천만 원으로 기준선보다 낮아 **medium downside risk**로 표시된다.
- **2016-03**: 평균 9.2천만 원, 하한 8.3천만 원으로 **high downside risk** 분류된다. 2014-03 및 2015-03처럼 봄철 매출이 낮았던 패턴을 반영한 것으로 보인다.


## 결론 및 한계

본 프로젝트는 데이터 양이 적은 상황에서도 다양한 시계열 모형과 딥러닝 모델을 평가하고, **CV를 기준으로 가장 일반화된 모델을 선택**하여 미래 5개월 예측을 제공했다. 주목해야 할 점은 다음과 같다:

1. **데이터 짧음의 영향** – 34개월은 계절·추세를 학습하기에 매우 짧다. SARIMAX처럼 파라미터가 많은 모델은 쉽게 과적합해 비현실적인 예측을 내놓았다. 딥러닝 모델 또한 안정성이 떨어졌다.
2. **베이스라인의 강점** – 최근 매출이 감소하는 추세에선 **마지막 값 반복**이 가장 안정적일 수 있다. CV에서는 iTransformer가 근소하게 우수했지만 holdout에서는 베이스라인이 더 낮은 RMSE를 기록했다.
3. **계절성/이벤트 효과** – 2014-12, 2015-01에 큰 스파이크가 존재했는데 이는 연말 프로모션 또는 특정 제품 출시의 영향으로 추정된다. 모델들은 이를 학습하여 2015-11~2015-12에 큰 상승을 예측했다.
4. **리스크 분석** – 예측 구간을 이용한 하방/상방 위험 평가는 의사결정에 도움을 준다. 2016-02~03은 매출이 기준선보다 낮을 가능성이 있어 대비가 필요하다.
